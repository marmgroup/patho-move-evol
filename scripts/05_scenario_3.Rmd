---
editor_options: 
  chunk_output_type: console
---

# Scenario 3: Evolution of Movement Types

```{r}
library(data.table)
library(ggplot2)
library(patchwork)
library(colorspace)
```

## Read data

```{r}
# load files
files = list.files("data/output/", pattern = "spillover", full.names = T)
data_sim = vector("list", length = length(files))
repl = c()
regrowth = c()
for (i in seq(length(files))) {
  load(files[i])
  data_sim[[i]] = data[["gen_data"]]
  repl = c(repl, data[["replicate"]])
  regrowth = c(regrowth, data[["regen_time"]])
}
```

## Generation level data

```{r}
# simulation wise data
data_sc3 = Map(
  data_sim, repl, regrowth,
  f = function(le, repl, regrowth) {
    
    le = Map(le[["pop_data"]], le[["gens"]],
        f = function(l, g) {
          l$gen = g
          l$repl = repl
          l$regrowth = regrowth
          l
        }
    ) |>
      rbindlist()
    
    le$repl = repl
    le$regrowth = regrowth
    # setnames(le, "energy", "intake")
    # le
    le[, list(
      mean_intake = mean(intake),
      sd_intake = sd(intake),
      mean_moved = mean(moved),
      sd_moved = sd(moved),
      mean_assoc = mean(assoc),
      sd_assoc = sd(assoc)
    ), by = c("gen", "repl", "regrowth")]
  }
) |>
  rbindlist()

# save
fwrite(data_sc3, file = "data/results/data_gen_sc3.csv")
```

```{r}
ggplot(data_sc3)+
  geom_line(
    aes(
      gen, mean_assoc
    )
  )+
  facet_grid(~regrowth)+
  scale_y_log10()+
  coord_cartesian(
    # ylim = c(1.5, 2.5)
  )
```


## Individual level data

```{r}
# simulation wise data
data = lapply(
  data_sim,
  function(le) {
    Map(le[["pop_data"]], le[["gens"]],
        f = function(l, g) {
          l$id = seq(nrow(l))
          l$gen = g
          l
        }
    ) |>
      rbindlist()
  }
)
```

### Evolution of Movement Types

```{r}
# get movement morphs
data_morphs = Map(
  data, repl, regrowth,
  f = function(d, repl, regrowth) {
    d = assign_movement_types(d)
    
    d$repl = repl
    d$regrowth = regrowth
    d
  }
)

# bind and count morphs
data_morphs = rbindlist(data_morphs)
data_morphs = data_morphs[, .N, by = c("gen", "move_strat", "repl", "regrowth")]

# save
fwrite(data_morphs, file = "data/results/data_morphs_sc3.csv")
```

```{r}
ggplot()+
  geom_area(data = data_morphs, 
            aes(gen, N, fill = move_strat))+
  facet_grid(~regrowth)
```


### Social information use

```{r}
# get movement morphs
data_si = Map(
  data, repl, regrowth,
  f = function(d, repl, regrowth) {
    get_social_strategy(d)
    d = d[, .N, by = c("gen", "strat_social")]
    
    d$repl = repl
    d$regrowth = regrowth
    d
  }
)

# bind and count morphs
data_si = rbindlist(data_si)

# save
fwrite(data_si, file = "data/results/data_si_sc3.csv")
```

```{r}
ggplot()+
  geom_area(data = data_si, aes(gen, N, fill = strat_social))+
  facet_grid(~regrowth)
```
