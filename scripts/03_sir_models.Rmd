---
editor_options: 
  chunk_output_type: console
---

# Run SIR models

Load libraries.

```{r}
library(igraph)
library(data.table)

library(ggplot2)
library(ggraph)
library(patchwork)
```

## Prepare parameters

```{r}
beta = c(1, seq(2, 10, 2))
gamma = c(seq(0, 1))
```

## Load networks

```{r}
load("data/results/data_networks.Rds")
```

```{r}
ntwk_basic = data_ntwk[names(data_ntwk) %in% c("nopatho", "endemic")]
parameters = CJ(
  beta, 
  gamma, 
  ntwk_basic, 
  scenario = names(ntwk_basic), 
  sorted = F
)
```

## Run basic models

```{r}
repl = rep(seq(5), 2)
data_basic = Map(
  parameters$ntwk_basic, parameters$scenario, 
  parameters$beta, parameters$gamma, repl,
  f = function(ntwk, scenario, beta, gamma, sc_repl) {
    data = igraph::sir(
      graph = last(ntwk), beta = beta, gamma = gamma, no.sim = 25
    ) |>
      handle_sir_data()
    
    data$scenario = scenario
    data$sc_repl = sc_repl
    data$beta = beta
    data$gamma = gamma
    
    data
  }
)

data_basic = rbindlist(data_basic)

# save data
fwrite(
  data_basic,
  file = "data/results/data_sir_basic.csv"
)
```

## Run on scenario 3

```{r}
ntwk_spillover = data_ntwk[names(data_ntwk) %in% c("spillover")]

# parameter combinations
parameters = CJ(
  beta, 
  gamma, 
  ntwk_spillover, 
  scenario = "spillover", 
  sorted = F
)
data_spillover = Map(
  parameters$ntwk_spillover, parameters$scenario, 
  parameters$beta, parameters$gamma, repl,
  f = function(ntwk, scenario, beta, gamma, sc_repl) {
    # data pre disease
    data_pre_disease = igraph::sir(
      graph = ntwk[[6]], beta = beta, gamma = gamma, no.sim = 25
    ) |>
      handle_sir_data()
    data_pre_disease$type = "pre"
    
    # data post disease
    data_post_disease = igraph::sir(
      graph = last(ntwk), beta = beta, gamma = gamma, no.sim = 25
    ) |>
      handle_sir_data()
    data_post_disease$type = "post"
    
    data = rbindlist(
      list(data_pre_disease, data_post_disease)
    )
    data$scenario = scenario
    data$sc_repl = sc_repl
    data$beta = beta
    data$gamma = gamma
    
    data
  }
)

data_spillover = rbindlist(data_spillover)

# save data
fwrite(
  data_spillover,
  file = "data/results/data_sir_spildata_spillover.csv"
)
```

