---
editor_options: 
  chunk_output_type: console
---

# Run SIR models

Load libraries.

```{r}
library(igraph)
library(data.table)

library(ggplot2)
library(ggraph)
library(patchwork)
```

## Prepare parameters

```{r}
beta = rep(c(5, 10), 2)
gamma = c(seq(0, 1), 1, 0)
```

## Load networks

```{r}
load("data/results/data_networks.Rds")
```

```{r}
ntwk_basic = data_ntwk[names(data_ntwk) %in% c("nopatho", "endemic")]
ntwk_basic = lapply(ntwk_basic, last)
```

## Run basic models

```{r}
sc_repl = rep(seq(5), 2)

data_basic = Map(
  ntwk_basic, names(ntwk_basic), sc_repl,
  f = function(ntwk, scenario, sc_repl) {
    
    # map over params
    d = Map(
      beta, gamma,
      f = function(b, g) {
        data = igraph::sir(
          graph = ntwk, beta = b, gamma = g, no.sim = 25
        ) |>
          handle_sir_data(digits = 1)
        
        data[, c("beta", "gamma") := list(b, g)]
        data
      }
    ) |>
      rbindlist()
    
    d[, c("scenario", "sc_repl") := list(scenario, sc_repl)]
    d
    
  }
)

data_basic = rbindlist(data_basic)

# save data
fwrite(
  data_basic,
  file = "data/results/data_sir_basic.csv"
)
```

## Run on scenario 3

```{r}
ntwk_spillover = data_ntwk[names(data_ntwk) %in% c("spillover")]

sc_repl = seq(5)

data_spillover = Map(
  ntwk_spillover, names(ntwk_spillover), sc_repl,
  f = function(ntwk, scenario, sc_repl) {
    
    # pre disease
    d_pre = Map(
      beta, gamma,
      f = function(b, g) {
        d_pre_ = igraph::sir(
          graph = ntwk[[6]], beta = b, gamma = g, no.sim = 25
        ) |>
          handle_sir_data(digits = 1)
        d_pre_$type = "pre"
        d_pre_$beta = b
        d_pre_$gamma = g
        d_pre_
      }
    ) |>
      rbindlist()
    
    # post disease
    d_post = Map(
      beta, gamma,
      f = function(b, g) {
        d_post_ = igraph::sir(
          graph = last(ntwk), beta = b, gamma = g, no.sim = 25
        ) |>
          handle_sir_data(digits = 1)
        d_post_$type = "post"
        d_post_$beta = b
        d_post_$gamma = g
        d_post_
      }
    ) |>
      rbindlist()
    
    data = rbindlist(
      list(d_pre, d_post)
    )
    
    data[, c("scenario", "sc_repl") := list(scenario, sc_repl)]
    data
    
  }
)

data_spillover = rbindlist(data_spillover)

# save data
fwrite(
  data_spillover,
  file = "data/results/data_sir_spillover.csv"
)
```

