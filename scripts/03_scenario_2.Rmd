---
editor_options: 
  chunk_output_type: console
---

# Scenario 2: Evolution of Movement Types

```{r}
library(data.table)
library(ggplot2)
library(patchwork)
```

## Read data

```{r}
# load files
files = list.files("data/output", pattern = "endemic", full.names = T)
data_sim = vector("list", length = length(files))
repl = c()
spread = c()
for (i in seq(length(files))) {
  load(files[i])
  data_sim[[i]] = data[["gen_data"]]
  repl = c(repl, data[["replicate"]])
  spread = c(spread, data[["clusterSpread"]])
}
```

## Individual level data

```{r}
# simulation wise data
data = lapply(
  data_sim,
  function(le) {
    Map(le[["pop_data"]], le[["gens"]],
        f = function(l, g) {
          l$id = seq(nrow(l))
          l$gen = g
          l
        }
    ) |>
      rbindlist()
  }
)
```

## Evolution of Movement Types

```{r}
# get movement morphs
data_morphs = Map(
  data, repl, spread,
  f = function(d, repl, spread) {
    d = d[, c("sF", "sH", "sN", "gen", "id")]
    d = melt(d, id.vars = c("gen", "id"))
    d[, scaled_value := value / sum(abs(value)), 
      by = c("gen", "id")]
    d = dcast(
      d[, !("value")],
      gen + id ~ variable,
      value.var = "scaled_value"
    )
    
    # assign strategy
    d[, move_strat := dplyr::case_when(
      sF > 0.6 ~ "prey tracking",
      ((sF > 0) & (sH > 0) & (abs(sF - sH) < 0.1))  ~ "prey and handler tracking",
      sH > 0.5 ~ "handler tracking",
      sH < -0.5 ~ "handler avoiding",
      sN > 0.5 ~ "non-handler tracking",
      sN < -0.5 ~ "non-handler avoiding",
      T ~ "other"
    )]
    
    d$repl = repl
    d$spread = spread
    d
  }
)

# bind and count morphs
data_morphs = rbindlist(data_morphs)
data_morphs = data_morphs[, .N, by = c("gen", "move_strat", "repl", "spread")]
```

```{r}
plot_move_types =
  ggplot(data_morphs)+
  geom_area(
    aes(gen, N, fill = move_strat)
  )+
  scale_fill_manual(
    values = c(
      "prey tracking" = "seagreen",
      "prey and handler tracking" = "royalblue",
      "non-handler avoiding" = "red",
      "handler avoiding" = "orange",
      "handler tracking" = "lightblue",
      "other" = "black",
      "NA" = "black"
    ),
    breaks = c(
      "prey tracking",
      "handler tracking",
      "prey and handler tracking",
      "non-handler avoiding",
      "handler avoiding",
      "other"
    ),
    na.value = "black"
  )+
  theme_test()+
  theme(
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    legend.position = "top",
    legend.key.width = unit(5, units = "mm"),
    legend.key.height = unit(1, "mm")
  )+
  facet_grid(
    repl ~ spread,
    labeller = label_both
  )+
  coord_cartesian(
    expand = F
  )+
  labs(
    x = "Generation",
    y = "# Agents",
    fill = NULL
  )

ggsave(
  plot_move_types,
  filename = "figures/fig_sc2_move_types.png",
  height = 6, width = 6
)
```

## Social information use

```{r}
# get movement morphs
data_si = Map(
  data, repl, spread,
  f = function(d, repl, spread) {
    d = d[, c("sF", "sH", "sN", "gen", "id")]
    d = d[, c("sH", "sN") := list(
      sH > 0, sN > 0
    )]
    d = d[, .N, by = c("gen", "sH", "sN")]
    
    d$repl = repl
    d$spread = spread
    d
  }
)

# bind and count morphs
data_si = rbindlist(data_si)
data_si[, c("sH", "sN") := lapply(.SD, `+`, 1), .SDcols = c("sH", "sN")]
```

```{r}
library(biscale)
plot_si = ggplot(data_si)+
  geom_area(
    aes(gen, N, fill = sprintf("%i-%i", sH, sN))
  )+
  bi_scale_fill(
    pal = "DkViolet", dim = 2,
    name = "Social cues",
    breaks = c("1-1", "2-1", "1-2", "2-2"),
    labels = c("Agent avoiding", "H+ N-", "H- N+", "Agent tracking")
  )+
  theme_test()+
  theme(
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    legend.position = "top",
    legend.key.width = unit(5, units = "mm"),
    legend.key.height = unit(1, "mm")
  )+
  facet_grid(
    repl ~ spread,
    labeller = label_both
  )+
  coord_cartesian(
    expand = F
  )+
  labs(
    x = "Generation",
    y = "# Agents",
    fill = NULL
  )

ggsave(
  plot_si,
  filename = "figures/fig_sc2_si_use.png",
  height = 6, width = 6
)
```

## Resource selection

```{r}
data_rs = Map(
  data, repl, spread,
  f = function(df, repl, spread) {
    df[, sF := sF > 0]
    df = df[,.N, by = c("gen", "sF")]
    
    df$repl = repl
    df$spread = spread
    df
})

data_rs = rbindlist(data_rs)
```

```{r}
ggplot(data_rs)+
  geom_area(
    aes(gen, N, fill = sF)
  )+
  scico::scale_fill_scico_d(
    palette = "bamako",
    direction = -1,
    labels = c("Resource avoiding", "Resource tracking")
  )+
  theme_test()+
  theme(
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    legend.position = "top",
    legend.key.width = unit(5, units = "mm"),
    legend.key.height = unit(1, "mm")
  )+
  facet_grid(
    repl ~ spread,
    labeller = label_both
  )+
  coord_cartesian(
    expand = F
  )+
  labs(
    x = "Generation",
    y = "# Agents",
    fill = NULL
  )
```