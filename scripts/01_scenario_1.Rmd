---
editor_options: 
  chunk_output_type: console
---

# Scenario 1: Evolution of Movement Types

```{r}
library(data.table)
library(ggplot2)
library(patchwork)
library(colorspace)
```

## Read data

```{r}
# load files and scenario names
files = list.files(
  "data/output/land_50_food_1000", 
  pattern = "Rds", full.names = T
)
scenarios = str_extract_all(files, pattern = "scenario_(\\w+)_") |> 
  str_remove_all("scenario|_")

# prepare lists to hold data
data_sim = vector("list", length = length(files))
repl = c()
cost = c()

# spread = c()
for (i in seq(length(files))) {
  load(files[i])
  data_sim[[i]] = data[["gen_data"]]
  repl = c(repl, data[["replicate"]])
  cost = c(cost, data[["costInfect"]])
}
```

## Generation level data

```{r}
# simulation wise data
data = Map(
  data_sim, repl, cost, scenarios,
  
  # map over simulations
  f = function(le, repl, cost, scenario) {
    # map over generations
    le = Map(le[["pop_data"]], le[["gens"]],
        f = function(l, g) {
          l$gen = g
          l$repl = repl
          # l$spread = spread
          if(g == 0) {
            NULL
          } else {
            l
          }
        }
    ) |>
      rbindlist()
    
    le$scenario = scenario
    # assign disease cost
    get_total_energy(le, cost_disease = cost)
    # summarise within sim
    le = le[, unlist(
      lapply(.SD, function(x) {
        list(
          mean = mean(x),
          sd = sd(x)
        )
      }), recursive = FALSE
    ), 
    .SDcols = c("energy", "intake", "moved", "assoc", "cost_disease"),
    by = c("gen", "repl", "scenario")]
  }
) |>
  rbindlist()

# save
fwrite(data, file = "data/results/data_gen.csv")
```

## Individual level data

```{r}
# simulation wise data
data = Map(
  data_sim, scenarios,
  f = function(le, scenario) {
    Map(le[["pop_data"]], le[["gens"]],
        f = function(l, g) {
          l$id = seq(nrow(l))
          l$gen = g
          l$scenario = scenario
          if(g == 0) {
            NULL
          } else {
            l
          }
        }
    ) |>
      rbindlist()
  }
)
```

### Evolution of Movement Types

```{r}
# get movement morphs
data_morphs = Map(
  data, repl, scenarios,
  f = function(d, repl, scenario) {
    assign_movement_types(d)
    get_social_strategy(d)
    d$repl = repl
    # d$scenario = scenario
    d
  }
)

# bind and count morphs
data_morphs = rbindlist(data_morphs)
# data_morphs = data_morphs[, .N, by = c("gen", "move_strat", "repl")]

# save
fwrite(data_morphs, file = "data/results/data_morphs.csv")
```

```{r}
ggplot()+
  geom_area(data = data_morphs, 
            aes(gen, N, fill = move_strat))+
  facet_grid(~repl)
```


### Social information use

```{r}
# get movement morphs
data_si = Map(
  data, repl, 
  f = function(d, repl) {
    get_social_strategy(d)
    d = d[, .N, by = c("gen", "strat_social")]
    
    d$repl = repl
    d
  }
)

# bind and count morphs
data_si = rbindlist(data_si)

# save
fwrite(data_si, file = "data/results/data_si_sc1.csv")
```

```{r}
ggplot()+
  geom_area(data = data_si, 
            aes(gen, N, fill = strat_social))+
  scale_fill_discrete_qualitative()+
  facet_grid(~repl)
```
