---
editor_options: 
  chunk_output_type: console
---

# Scenario 1: Evolution of Movement Types

```{r}
library(data.table)
library(stringr)
library(ggplot2)
library(glue)

# load local funs
devtools::load_all()
```

## Read data

```{r}
# load files and scenario names
files = list.files(
  "data/output/", 
  pattern = "Rds", full.names = T
)
```

## Sanity check

```{r}
f = files[3]
load(f)
names(data)
```

Check SI importance.

```{r}
gen_data = data[["gen_data"]]

# prepare generation level data
gen_data = Map(
  gen_data[["pop_data"]], gen_data[["gens"]],
  f = function(l, g) {
    l$gen = g
    l
  }
)

#### prepare individual level data ####
popsize = data[["popsize"]]

gen_data = Map(
  gen_data,
  f = function(df) {
    
    # add individual identity
    df$id = seq(popsize)
    
    # get strategy --- assignment necessary
    df = mspathomove::get_social_strategy(df)

    # scale weights and get social information importance
    mspathomove::get_social_strategy(df)
    mspathomove::get_si_importance(df)
    mspathomove::get_agent_avoidance(df)
    
    df
    
  }
)
```

```{r}
df = rbindlist(gen_data)

ggplot(df)+
  geom_bin2d(
    aes(
      gen, agent_avoidance
    ),
    binwidth = c(10, 0.01)
  )+
  scale_fill_viridis_c(
    direction = -1
  )
```

## Process each file

```{r}
# where to send output
gen_data_path = "data/results/gen_data"
morph_data_path = "data/results/morph_data"
si_imp_path = "data/results/si_imp_data"

# make directories if non existent
lapply(
  list(gen_data_path, morph_data_path, si_imp_path), 
  function(p) {
    if(!dir.exists(p)) {
      # message
      message(
        glue(
          "creating filepath {p}"
        )
      )
      dir.create(p)
    }
  }
)
```


```{r}
# use a loop because
for (i in files) {
  
  # load data
  load(i)
  
  uid = str_extract(i, "\\d+")
  
  # load metadata on the simulation
  gen_data = data[["gen_data"]]
  repl = data[["replicate"]]
  cost = data[["costInfect"]]
  regen = data[["regen_time"]]
  local = data[["local_dispersal"]]
  infect_percent = data[["infect_percent"]]
  
  # prepare generation level data
  gen_data = Map(
    gen_data[["pop_data"]], gen_data[["gens"]],
    f = function(l, g) {
      l$gen = g
      l
    }
  )
  
  #### prepare individual level data ####
  popsize = data[["popsize"]]
  
  gen_data = Map(
    gen_data,
    f = function(df) {
      
      # add individual identity
      df$id = seq(popsize)
      
      # get strategy --- assignment necessary
      df = mspathomove::get_social_strategy(df)

      # scale weights and get social information importance
      mspathomove::get_social_strategy(df)
      mspathomove::get_si_importance(df)
      mspathomove::get_agent_avoidance(df)
      
      df
      
    }
  )
  
  # process by social strategy
  data_strategy = Map(
    gen_data,
    f = function(df) {
      df[, list(
        N = .N,
        mean_move = mean(moved),
        mean_assoc = mean(assoc),
        mean_intake = mean(intake),
        prop_infec = sum(t_infec > 0) / length(t_infec)
      ), by = c("gen", "social_strat")]
    }
  ) |> rbindlist()
  
  # summarise by generation
  # bind all together
  gen_data = rbindlist(gen_data)
  
  gen_data = gen_data[, unlist(
    lapply(.SD, function(x) {
      list(
        mean = mean(x),
        sd = sd(x)
      )
    }), recursive = FALSE
  ), 
  .SDcols = c("energy", "intake", "moved", "assoc"),
  by = c("gen")]
  
  # add simulation parameters
  invisible(
    lapply(
      list(data_strategy, gen_data), 
      function(df) {
        df[, c("repl", "cost", "regen", "local", "infect_percent") := list(
          repl, cost, regen, local, infect_percent
        )]
      }
    )
  )
  
  # save data
  invisible(
    Map(
      list(data_strategy, gen_data), 
      list(morph_data_path, gen_data_path),
      f = function(df, p) {
        fwrite(
          df,
          file = glue(
            "{p}/data_gen_{uid}.csv"
          )
        )
      }
    )
  )
  
}
```

```{r}
# get importance of social information
# data_si_imp = Map(
#   data, repl, cost, regen, scenarios, local,
#   f = function(d, repl, cost, regen, scenario, local) {
#     # assign_movement_types(d)
#     d[, si_imp := (abs(sH) + abs(sN)) / (abs(sH) + abs(sN) + abs(sF))]
#     d[, si_bin := plyr::round_any(si_imp, 0.01)]
#     d$repl = repl
#     d$cost = cost
#     d$regen = regen
#     d$local = local
#     # d$scenario = scenario
#     d[, .N, by = c("repl", "gen", "cost", "regen", "local", "si_bin")]
#   }
# )
# 
# # bind and count morphs
# data_si_imp = rbindlist(data_si_imp)
# # data_morphs = data_morphs[, .N, by = c("gen", "move_strat", "repl")]
# 
# # save
# fwrite(data_si_imp, file = "data/results/data_si_imp.csv")
```
