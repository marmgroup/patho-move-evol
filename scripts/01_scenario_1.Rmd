---
editor_options: 
  chunk_output_type: console
---

# Scenario 1: Evolution of Movement Types

```{r}
library(data.table)
library(stringr)

# load local funs
devtools::load_all()
```

## Read data

```{r}
# load files and scenario names
files = list.files(
  "data/output/", 
  pattern = "Rds", full.names = T
)
scenarios = str_extract_all(files, pattern = "scenario_(\\w+)_") |> 
  str_remove_all("scenario|_")

# prepare lists to hold data
data_sim = vector("list", length = length(files))
repl = c()
cost = c()
regen = c()
```

## Sanity check

```{r}
f = files[21]
load(f)
names(data)

move_pre = rbindlist(data[["move_pre"]])

ggplot(move_pre)+
  geom_point(
    aes(x, y, group = id, col = as.factor(id)),
    show.legend = F,
    size = 0.3
  )
```

```{r}
# spread = c()
for (i in seq(length(files))) {
  load(files[i])
  data_sim[[i]] = data[["gen_data"]]
  repl = c(repl, data[["replicate"]])
  cost = c(cost, data[["costInfect"]])
  regen = c(regen, data[["regen_time"]])
}
```

## Generation level data

```{r}
# simulation wise data
data = Map(
  data_sim, repl, cost, regen, scenarios,
  
  # map over simulations
  f = function(le, repl, cost, regen, scenario) {
    # map over generations
    le = Map(le[["pop_data"]], le[["gens"]],
        f = function(l, g) {
          l$gen = g
          l$repl = repl
          # l$spread = spread
          if(g == 0) {
            NULL
          } else {
            l
          }
        }
    ) |>
      rbindlist()
    
    le$scenario = scenario
    le$cost = cost
    le$regen = regen
    
    # assign disease cost
    get_total_energy(le, cost_disease = cost)
    # summarise within sim
    le = le[, unlist(
      lapply(.SD, function(x) {
        list(
          mean = mean(x),
          sd = sd(x)
        )
      }), recursive = FALSE
    ), 
    .SDcols = c("energy", "intake", "moved", "assoc", "cost_disease"),
    by = c("gen", "repl", "scenario", "regen", "cost")]
  }
) |>
  rbindlist()

# save
fwrite(data, file = "data/results/data_gen.csv")
```

```{r}
data |>
  ggplot()+
  geom_bin_2d(
    aes(
      gen, intake.mean
    )
  )+
  scale_fill_viridis_c()+
  facet_grid(
    cost ~ regen,
    labeller = label_both
  )
```

## Individual level data

```{r}
# simulation wise data
data = Map(
  data_sim, scenarios,
  f = function(le, scenario) {
    Map(le[["pop_data"]], le[["gens"]],
        f = function(l, g) {
          l$id = seq(nrow(l))
          l$gen = g
          l$scenario = scenario
          if(g == 0) {
            NULL
          } else {
            l
          }
        }
    ) |>
      rbindlist()
  }
)
```

### Evolution of Movement Types

```{r}
# get movement morphs
data_morphs = Map(
  data, repl, cost, regen, scenarios,
  f = function(d, repl, cost, regen, scenario) {
    # assign_movement_types(d)
    get_social_strategy(d)
    d$repl = repl
    d$cost = cost
    d$regen = regen
    # d$scenario = scenario
    d[, list(
      N = length(moved),
      mean_move = mean(moved),
      mean_assoc = mean(assoc),
      mean_intake = mean(intake),
      prop_infec = sum(t_infec > 0) / length(t_infec)
    ), by = c("gen", "social_strat", 
                   "repl", "cost", "regen")]
  }
)

# bind and count morphs
data_morphs = rbindlist(data_morphs)
# data_morphs = data_morphs[, .N, by = c("gen", "move_strat", "repl")]

# save
fwrite(data_morphs, file = "data/results/data_si_morphs.csv")
```

```{r}
# get importance of social information
data_si_imp = Map(
  data, repl, cost, regen, scenarios,
  f = function(d, repl, cost, regen, scenario) {
    # assign_movement_types(d)
    d[, si_imp := abs(sH) + abs(sN) ]
    d[, si_bin := plyr::round_any(si_imp, 0.05)]
    d$repl = repl
    d$cost = cost
    d$regen = regen
    # d$scenario = scenario
    d[, .N, by = c("repl", "cost", "regen", "si_imp")]
  }
)

# bind and count morphs
data_si_imp = rbindlist(data_si_imp)
# data_morphs = data_morphs[, .N, by = c("gen", "move_strat", "repl")]

# save
fwrite(data_si_imp, file = "data/results/data_si_imp.csv")
```


```{r}
data_morphs |>
  ggplot()+
  geom_point(
    aes(
      gen, N,
      col = social_strat
    ),
    size = 0.2
  )+
  facet_grid(
    cost ~ regen,
    labeller = label_both
  )
```

