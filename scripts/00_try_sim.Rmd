---
editor_options: 
  chunk_output_type: console
---

# Trying out the _Pathomove_ simulation model

## Installation

```{r}
# install using devtools
devtools::install_github("pratikunterwegs/pathomove", upgrade = "never")
```

```{r}
# load package
library(pathomove)
```

```{r}
# load some helper libraries
library(ggplot2)
library(data.table)
```

## Visualise the simulation landscape

The kind of simulation landscape used in our study can be visualised using the code below.

```{r}
# using the Rcpp function to get a sample landscape
l <- pathomove::get_test_landscape(
  nItems = 1800,
  landsize = 60,
  nClusters = 60,
  clusterSpread = 1,
  regen_time = 50
)
```

```{r}
# visualise the landscape,
# colouring items by tAvail
# tAvail is the time before the item regenerates
ggplot(l) +
  geom_point(
    aes(x, y, col = tAvail)
  ) +
  scale_colour_viridis_c(
    option = "H"
  )
```

## Run a test simulation

```{r}
# run a test simulation.
# see the help using ?run_pathomove 
# for an explanation of the parameters
data = pathomove::run_pathomove(
  scenario = 2,
  popsize = 200,
  nItems = 1000,
  landsize = 60,
  nClusters = 60,
  clusterSpread = 1,
  tmax = 100,
  genmax = 100,
  g_patho_init = 50,
  range_food = 1.0,
  range_agents = 1.0,
  range_move = 1.0,
  handling_time = 5,
  regen_time = 50,
  pTransmit = 0.05,
  initialInfections = 40,
  costInfect = 0.25,
  nThreads = 2,
  dispersal = 2.0,
  infect_percent = FALSE,
  mProb = 0.001,
  mSize = 0.001
)
```

## Simulation output

Examine the simulation data. It consists of four elements, which can be examined.

```{r}
# examine the structure of the data
str(data, max.level = 1)
```

```md
List of 4
 $ gen_data :List of 3
 $ edgeLists:List of 11
 $ move_pre :List of 100
 $ move_post:List of 100
```

Here:

- `gen_data` are data related to the evolved population,
- `edgeLists` are the pairwise associations between individuals
- `move_pre` and `move_post` are the movement paths of individuals before and after pathogen introduction.

### Sanity check: Expected movement patterns

Examine whether individuals are moving as expected, in five point trajectories.

```{r}
# movement data before and after pathogen
m1 <- data[["move_pre"]] |> rbindlist()
m2 <- data[["move_post"]] |> rbindlist()

# examine the movement patterns
ggplot(m1) +
  geom_point(
    aes(x, y, group = id, col = id),
    # size = 0.1
  ) +
  scale_colour_viridis_c(
    option = "H"
  ) +
  coord_equal()
```

data <- a
a <- data[[1]]
names(a)

plot(a[["gens"]], a[["n_infected"]], type = "o", pch = 16)

#### handle data ####
b <- copy(a)
b <- Map(function(l, g) {
  l$id <- seq(nrow(l))
  l$gen <- g
  l
}, b$pop_data, b$gens)
b <- rbindlist(b)
b
# b = b[(gen %% 100 == 0) | (gen == 9999),]

#### examine strategies ####
d <- copy(b)
d[, social_strat := fcase(
  (sH > 0 & sN > 0), "agent tracking",
  (sH > 0 & sN <= 0), "handler tracking",
  (sH <= 0 & sN > 0), "non-handler tracking",
  (sH <= 0 & sN <= 0), "agent avoiding"
)]

df <- d[, .N, by = c("gen", "social_strat")]

ggplot(df) +
  geom_point(
    aes(
      gen, N,
      col = social_strat
    )
  )

#### plot data ####
b <- melt(b, id.vars = c("gen", "id"))

ggplot(b[variable %in% c("intake", "moved")]) +
  stat_summary(
    aes(
      gen, value
    )
  ) +
  facet_wrap(~variable, scales = "free")

# energy = b[variable == "energy",]
wts <- b[!variable %in% c("energy", "assoc", "t_infec", "moved", "degree"), ]

#### explore network ####
library(igraph)
# g = data[["matrices"]][4:6]
# g = g[[3]]
setnames(b, "assoc", "weight")
g <- igraph::graph_from_data_frame(b[b$weight > 0, ], directed = FALSE)

plot(g, vertex.size = 3, vertex.label = NA)

library(tidygraph)
library(ggraph)

g <- tidygraph::as_tbl_graph(g)

ggraph(g, layout = "mds") +
  geom_node_point() +
  geom_edge_link()
