---
editor_options: 
  chunk_output_type: console
---

```{r}
library(data.table)

library(ggplot2)
library(patchwork)
library(colorspace)

# custom functions
devtools::load_all()
```


Load generation data.

```{r}
# load data
data = fread("data/results/data_gen.csv")
data = data[scenario == "spillover" & regen == 50 & cost == 0.25]

# summarise etc
data[, gen_round := plyr::round_any(gen, 10)]
data[, energy.mean := fifelse(scenario == "spillover" & gen < 3334, NA_real_, energy.mean)]

# add col for representation
data[, gen_abs := gen - 3334]
```

## Intake and energy

```{r}
data = data[, c("gen_abs", "intake.mean", 
                       "energy.mean", "moved.mean", "assoc.mean")]
data = melt(
  data,
  id.vars = "gen_abs"
)
```


```{r}
plot_intake =
ggplot(data[variable %in% c("intake.mean")])+
  geom_bin2d(
    data = data[variable == "intake.mean"],
    aes(
      gen_abs, value,
    ),
    binwidth = c(0.2, 0.25),
    show.legend = F,
    alpha = 0.8
  )+
  geom_vline(
    data = data.table(
      x = 0, # 0.667 * 5000,
      scenario = 3
    ),
    aes(
      xintercept = x
    ),
    lty = 3
  )+
  stat_summary(
    fun = mean,
    fun.min = ci_lower,
    fun.max = ci_upper,
    aes(
      gen_abs, value,
      colour = variable,
    ),
    geom = "line",
    alpha = 0.8,
    show.legend = F
  )+
  stat_summary(
    data = data[variable %in% c("intake.mean") & 
           between(gen_abs, -25, 25)],
    fun = mean,
    fun.min = ci_lower,
    fun.max = ci_upper,
    aes(
      gen_abs, value,
      colour = variable,
      shape = variable
    ),
    fill = "grey99",
    show.legend = F
  )+
  scale_fill_continuous_sequential(
    palette = "Viridis",
    trans = "sqrt"
  )+
  scale_shape_manual(
    values = c(21, 24),
    breaks = c("intake.mean"),
    labels = c("Intake")
  )+
  scale_colour_manual(
    values = c("grey20"),
    breaks = c("intake.mean"),
    labels = c("Intake")
  )+
  scale_x_continuous(
    trans = ggallin::pseudolog10_trans,
    breaks = c(-3000, -100, -5, 5, 100, 1500),
    labels = scales::comma_format(
      accuracy = 1
    ),
    name = "Gens. since spillover",
    sec.axis = sec_axis(
      trans = function(x) x + 3334,
      breaks = c(0, 3000, 3334, 5000),
      labels = scales::comma_format(
        accuracy = 1
      ),
      name = "Generations"
    )
  )+
  theme_test(base_family = "Arial")+
  theme(
    # legend.position = c(0.2, 0.15),
    legend.key = element_blank(),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    )
  )+
  labs(
    x = NULL,
    y = "Per-capita intake",
    colour = NULL,
    shape = NULL
  )
```

```{r}
ggsave(
  plot_intake,
  filename = "figures/fig_energy_intake.png",
  height = 3, width = 3
)
```

## Movement

```{r}
plot_movement =
ggplot(data[variable %in% c("moved.mean")])+
  geom_bin2d(
    aes(
      gen_abs, value,
    ),
    binwidth = c(0.2, 1),
    show.legend = F,
    alpha = 0.8
  )+
  geom_hline(
    yintercept = 0,
    lty = 3
  )+
  geom_vline(
    data = data.table(
      x = 0, # 0.667 * 5000,
      scenario = 3
    ),
    aes(
      xintercept = x
    ),
    lty = 3
  )+
  stat_summary(
    fun = mean,
    fun.min = ci_lower,
    fun.max = ci_upper,
    aes(
      gen_abs, value,
    ),
    colour = "grey20",
    geom = "line",
    alpha = 0.8
  )+
  stat_summary(
    data = data[variable %in% c("moved.mean") & 
           between(gen_abs, -25, 25)],
    fun = mean,
    fun.min = ci_lower,
    fun.max = ci_upper,
    aes(
      gen_abs, value,
      shape = variable
    ),
    colour = "grey20",
    fill = "grey99",
    shape = 21
  )+
  scale_fill_continuous_sequential(
    palette = "Mako",
    trans = "sqrt"
  )+
  scale_x_continuous(
    trans = ggallin::pseudolog10_trans,
    breaks = c(-3000, -100, -5, 5, 100, 1500),
    labels = scales::comma_format(
      accuracy = 1
    ),
    name = "Gens. since spillover",
    sec.axis = sec_axis(
      trans = function(x) x + 3334,
      breaks = c(0, 3000, 3334, 5000),
      labels = scales::comma_format(
        accuracy = 1
      ),
      name = "Generations"
    )
  )+
  theme_test(base_family = "Arial")+
  theme(
    # legend.position = c(0.2, 0.15),
    legend.key = element_blank(),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    )
  )+
  coord_cartesian(
    ylim = c(30, 90)
  )+
  labs(
    x = NULL,
    y = "Distance moved",
    colour = NULL,
    shape = NULL
  )
```

```{r}
ggsave(
  plot_movement,
  filename = "figures/fig_movement.png",
  height = 3, width = 3
)
```

## Associations

```{r}
plot_assoc =
ggplot(data[variable %in% c("assoc.mean")])+
  geom_bin2d(
    aes(
      gen_abs, value,
    ),
    binwidth = c(0.2, 0.05),
    show.legend = F,
    alpha = 0.8
  )+
  geom_hline(
    yintercept = 0,
    lty = 3
  )+
  geom_vline(
    data = data.table(
      x = 0, # 0.667 * 5000,
      scenario = 3
    ),
    aes(
      xintercept = x
    ),
    lty = 3
  )+
  stat_summary(
    fun = mean,
    fun.min = ci_lower,
    fun.max = ci_upper,
    aes(
      gen_abs, value,
    ),
    colour = "grey20",
    geom = "line",
    alpha = 0.8
  )+
  stat_summary(
    data = data[variable %in% c("assoc.mean") & 
           between(gen_abs, -25, 25)],
    fun = mean,
    fun.min = ci_lower,
    fun.max = ci_upper,
    aes(
      gen_abs, value,
      shape = variable
    ),
    colour = "grey20",
    fill = "grey99",
    shape = 21
  )+
  scale_fill_continuous_sequential(
    palette = "Rocket"
  )+
  scale_x_continuous(
    trans = ggallin::pseudolog10_trans,
    breaks = c(-3000, -100, -5, 5, 100, 1500),
    labels = scales::comma_format(
      accuracy = 1
    ),
    name = "Gens. since spillover",
    sec.axis = sec_axis(
      trans = function(x) x + 3334,
      breaks = c(0, 3000, 3334, 5000),
      labels = scales::comma_format(
        accuracy = 1
      ),
      name = "Generations"
    )
  )+
  scale_y_continuous(
    trans = "log10",
    labels = scales::comma
  )+
  theme_test(base_family = "Arial")+
  theme(
    legend.position = c(0.2, 0.15),
    legend.key = element_blank(),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    axis.text.y = element_text(
      angle = 90, hjust = 0.5
    )
  )+
  labs(
    x = NULL,
    y = "Encounters w/ individuals",
    colour = NULL,
    shape = NULL
  )
```

```{r}
ggsave(
  plot_assoc,
  filename = "figures/fig_assoc.png",
  height = 3, width = 3
)
```

## Make Figure 1

```{r}
fig_2 =
wrap_plots(
  # plot_agent_avoid,
  plot_movement,
  plot_intake, 
  plot_assoc,
  ncol = 3
  # guides = "collect"
) &
  plot_annotation(
    tag_levels = c("A", 1)
  ) &
  theme(
    legend.position = "top",
    legend.key.height = unit(1, units = "mm"),
    plot.tag = element_text(
      face = "bold",
      size = 10
    ),
    axis.text.x = element_text(
      size = 7
    )
  )

ggsave(
  fig_2,
  filename = "figures/fig_02.png",
  height = 69, width = 174, units = "mm"
)
```
