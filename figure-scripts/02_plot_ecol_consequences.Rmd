---
editor_options: 
  chunk_output_type: console
---

```{r}
library(data.table)

library(ggplot2)
library(patchwork)
library(colorspace)

# custom functions
devtools::load_all()
```

## Focal strategy data

Load generation strategy data.

```{r}
files = list.files(
  "data/results/morph_data", 
  pattern = "csv",
  full.names = TRUE
)

data_all = lapply(files, fread)
data_all = rbindlist(data_all)

df_strat = data_all[(local == 1) & (infect_percent == T)]
df_strat = df_strat[(cost == 0.075) & (regen == 50)]

# popsize
popsize = 500
df_strat[, prop := N / popsize]
g_bin = 10
df_strat[, gen_bin := (floor(gen / g_bin) * g_bin)]

# get time since pathogen
sgen = 500
df_strat[, gen_abs := gen_bin - sgen]
```

## Plot evolutionary change in default scenario

```{r}
fig_1a =
ggplot(df_strat[
  social_strat != "non-handler tracking"
])+
  stat_summary(
    fun.max = ci_upper,
    fun.min = ci_lower,
    aes(
      gen_abs, prop, 
      fill = social_strat,
      # alpha = gen_bin > 500
    ),
    geom = "ribbon"
  )+
  stat_summary(
    fun = mean,
    aes(
      gen_abs, prop,
      group = social_strat
    ),
    col = "grey30",
    geom = "line"
  )+
  geom_vline(
    xintercept = 0,
    lty = 2,
    size = 0.3,
    col = "red"
  )+
  scale_fill_discrete_sequential(
    palette = "Viridis",
    l1 = 50, l2 = 70,
    rev = F,
    name = NULL,
    limits = c("agent avoiding", "agent tracking", "handler tracking"),
    labels = stringr::str_to_sentence,
    na.value = "lightgrey"
  )+
  scale_x_continuous(
    trans = ggallin::ssqrt_trans,
    breaks = c(-250, -25, -5, 5, 25, 250),
    labels = scales::comma_format(
      accuracy = 1
    ),
    name = "Gens. since spillover",
    sec.axis = sec_axis(
      trans = function(x) x + sgen,
      breaks = c(1, 250, 500),
      labels = scales::comma_format(
        accuracy = 1
      ),
      name = "Generations"
    )
  )+
  scale_y_continuous(
    breaks = c(0, 0.5, 1),
    labels = scales::percent,
    name = "% Individuals"
  )+
  coord_cartesian(
    # expand = F,
    # ylim = c(0, 1),
    # xlim = c(1, 2000)
  )+
  theme_test(
    base_family = "Arial",
    base_size = 8
  )+
  theme(
    legend.position = "top", 
    legend.key.height = unit(1, "mm"),
    strip.placement = "outside",
    strip.text = ggtext::element_markdown(),
    axis.text.x = element_text(hjust = 0.5, size = 6)
  )+
  guides(
    alpha = "none",
    colour = guide_legend(
      override.aes = list(
        size = 2
      )
    )
  )
```

## Data ecological outcomes

Load generation data.

```{r}
# list files, read, and filter for default model options
files = list.files(
  "data/results/gen_data", 
  pattern = "csv",
  full.names = TRUE
)

data_all = lapply(files, fread)
data_all = rbindlist(data_all)

data = data_all[(infect_percent == T) & (local == 1)]
```

```{r}
# load data
data = data[regen == 50 & cost == 0.075]

# summarise etc
data[, gen_round := floor(gen / 10) * 10]

# spillover gen
sgen = 500

# add col for representation
data[, gen_abs := gen - sgen]
```

### Intake

```{r}
data = data[, c("gen_abs", "intake.mean", 
                       "energy.mean", "moved.mean", "assoc.mean")]
data = melt(
  data,
  id.vars = "gen_abs"
)

## colours for background
cols = RColorBrewer::brewer.pal(3, "Dark2")
```

```{r}
plot_intake =
ggplot(data[variable %in% c("intake.mean")])+
  stat_summary(
    # fun = mean,
    # fun.min = ci_lower,
    # fun.max = ci_upper,
    aes(
      gen_abs, value
    ),
    geom = "ribbon",
    size = 0.2,
    # colour = "grey",
    fill = alpha(cols[1], 0.3),
    show.legend = F
  )+
  stat_summary(
    fun = mean,
    # fun.min = ci_lower,
    # fun.max = ci_upper,
    aes(
      gen_abs, value,
    ),
    colour = "grey30",
    geom = "line",
    show.legend = F
  )+
  geom_vline(
    xintercept = c(0, 25),
    lty = 2,
    size = 0.3,
    col = "red"
  )+
  scale_x_continuous(
    trans = ggallin::ssqrt_trans,
    breaks = c(-sgen, -25, 25, sgen),
    labels = scales::comma_format(
      accuracy = 1
    ),
    name = "Gens. since spillover",
    sec.axis = sec_axis(
      trans = function(x) x + sgen,
      breaks = c(1, sgen, 1000),
      labels = scales::comma_format(
        accuracy = 1
      ),
      name = "Generations"
    )
  )+
  theme_test(
    base_family = "Arial",
    base_size = 8
  )+
  theme(
    # legend.position = c(0.2, 0.15),
    legend.key = element_blank(),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    strip.placement = "outside"
  )+
  labs(
    x = NULL,
    y = "Per-capita intake",
    colour = NULL,
    shape = NULL
  )
```

```{r}
ggsave(
  plot_intake,
  filename = "figures/fig_energy_intake.png",
  height = 3, width = 3
)
```

## Movement

```{r}
plot_movement =
ggplot(data[variable %in% c("moved.mean")])+
  stat_summary(
    aes(
      gen_abs, value
    ),
    geom = "ribbon",
    size = 0.2,
    # colour = "grey",
    fill = alpha(cols[3], 0.3),
    show.legend = F
  )+
  stat_summary(
    fun = mean,
    # fun.min = ci_lower,
    # fun.max = ci_upper,
    aes(
      gen_abs, value
    ),
    colour = "grey30",
    geom = "line",
    show.legend = F
  )+
  geom_vline(
    data = data.table(
      x = 0, # 0.667 * 5000,
      scenario = 3
    ),
    aes(
      xintercept = x
    ),
    lty = 3
  )+
  scale_x_continuous(
    trans = ggallin::ssqrt_trans,
    breaks = c(-sgen, -25, -5, 5, 25, sgen),
    labels = scales::comma_format(
      accuracy = 1
    ),
    name = "Gens. since spillover",
    sec.axis = sec_axis(
      trans = function(x) x + sgen,
      breaks = c(1, 500, 1000),
      labels = scales::comma_format(
        accuracy = 1
      ),
      name = "Generations"
    )
  )+
  theme_test(
    base_family = "Arial",
    base_size = 8
  )+
  theme(
    # legend.position = c(0.2, 0.15),
    legend.key = element_blank(),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    strip.placement = "outside"
  )+
  labs(
    x = NULL,
    y = "Distance moved",
    colour = NULL,
    shape = NULL
  )
```

```{r}
ggsave(
  plot_movement,
  filename = "figures/fig_movement.png",
  height = 3, width = 3
)
```

## Associations

```{r}
plot_assoc =
ggplot(data[variable %in% c("assoc.mean")])+
  stat_summary(
    aes(
      gen_abs, value
    ),
    geom = "ribbon",
    size = 0.2,
    fill = alpha(cols[2], 0.3),
    show.legend = F
  )+
  stat_summary(
    fun = mean,
    # fun.min = ci_lower,
    # fun.max = ci_upper,
    aes(
      gen_abs, value,
    ),
    colour = "grey30",
    geom = "line",
    show.legend = F
  )+
  geom_vline(
    data = data.table(
      x = 0, # 0.667 * 5000,
      scenario = 3
    ),
    aes(
      xintercept = x
    ),
    lty = 3
  )+
  scale_x_continuous(
    trans = ggallin::ssqrt_trans,
    breaks = c(-sgen, -25, -5, 5, 25, sgen),
    labels = scales::comma_format(
      accuracy = 1
    ),
    name = "Gens. since spillover",
    sec.axis = sec_axis(
      trans = function(x) x + sgen,
      breaks = c(1, 250, 500),
      labels = scales::comma_format(
        accuracy = 1
      ),
      name = "Generations"
    )
  )+
  scale_y_continuous(
    trans = "log10",
    labels = scales::comma
  )+
  theme_test(
    base_family = "Arial",
    base_size = 8
  )+
  theme(
    # legend.position = c(0.2, 0.15),
    legend.key = element_blank(),
    legend.background = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(
      face = "italic"
    ),
    axis.text.y = element_text(
      angle = 90, hjust = 0.5
    ),
    strip.placement = "outside"
  )+
  labs(
    x = NULL,
    y = "Associations",
    colour = NULL,
    shape = NULL
  )
```

```{r}
ggsave(
  plot_assoc,
  filename = "figures/fig_assoc.png",
  height = 3, width = 3
)
```

## Make Figure 1

```{r}
fig_1 =
wrap_plots(
  # plot_agent_avoid,
  fig_1a,
  plot_movement,
  plot_intake, 
  plot_assoc,
  ncol = 2,
  guides = "collect"
) &
  plot_annotation(
    tag_levels = c("A", 1)
  ) &
  theme(
    legend.position = "top",
    legend.justification = 0,
    legend.key.height = unit(1, units = "mm"),
    plot.tag = element_text(
      face = "bold",
      size = 10
    ),
    axis.text.x = element_text(
      size = 7
    )
  )

ggsave(
  fig_1,
  filename = "figures/fig_01.png",
  height = 120, width = 120, units = "mm"
)
```
