---
editor_options: 
  chunk_output_type: console
---

# Plot evolutionary consequences of spillover

```{r}
library(data.table)

library(ggplot2)
library(patchwork)
library(colorspace)

# custom functions
devtools::load_all()
```

Load data.

```{r}
files = list.files(
  "data/results/morph_data", 
  pattern = "csv",
  full.names = TRUE
)

data_all = lapply(files, fread)
df_strat = rbindlist(data_all)

# popsize
popsize = 500
replicates = 10
df_strat[, prop := N / popsize]
g_bin = 100
df_strat[, gen_bin := (floor(gen / g_bin) * g_bin)]

# get time since pathogen
sgen = 3000
genmax = 5000
df_strat[, gen_abs := gen_bin - sgen]

df_strat = df_strat[gen %% 100 == 0,]

df_strat = df_strat[, list(
  prop = sum(prop) / (replicates)
), by = c("gen", "social_strat", "cost", "regen", "infect_percent")]

# regeneration rate
gen_time = 100
df_strat[, regen_r := gen_time / regen]
```

```{r}
df_strat = split(
  df_strat,
  by = "infect_percent"
)
```

## Compare strategy evolution

```{r}
# rough draft
plots_evo = lapply(
  df_strat,
  function(df) {
    
    p = ggplot(df)+
      geom_col(
        aes(
          gen, prop,
          fill = social_strat
        ),
        width = 100,
        position = "stack"
      )+
      geom_vline(
        xintercept = sgen,
        lty = 2,
        size = 0.3,
        col = "red"
      )+
      scale_fill_discrete_sequential(
        palette = "Viridis",
        l2 = 80,
        rev = F,
        name = NULL,
        limits = c("agent avoiding", "agent tracking", "handler tracking"),
        labels = stringr::str_to_sentence,
        na.value = "lightgrey"
      )+
      scale_x_continuous(
        breaks = sgen,
        labels = "Pathogen introduction",
        name = "Increasing productivity (social information less useful) \u279c",
        sec.axis = dup_axis(
          breaks = c(1000, sgen, genmax),
          labels = scales::comma,
          name = "Generations"
        )
      )+
      scale_y_continuous(
        labels = scales::percent,
        breaks = NULL,
        name = glue::glue("Increasing disease cost \u279c"),
        sec.axis = dup_axis(
          breaks = c(0, 0.5, 1),
          labels = scales::percent,
          name = "% Individuals"
        )
      )+
      facet_grid(
        cost ~ regen_r,
        as.table = F, 
        switch = c("both"),
        labeller = labeller(
          cost = function(x) sprintf("δE = %s", x),
          regen_r = function(x) sprintf("R = %s times/gen", x)
        )
      )+
      coord_cartesian(
        expand = F
      )+
      theme_test(
        base_size = 8, 
        base_family = "Arial"
      )+
      theme(
        legend.position = "top", 
        legend.key.height = unit(1, "mm"),
        strip.placement = "outside",
        strip.text = ggtext::element_markdown(),
        axis.text.x = element_text(hjust = 0.5, size = 6)
      )
    
    p
  }
)
```

```{r}
# save fig 05
ggsave(
  plot = plots_evo[[1]],
  filename = "figures/fig_05.png",
  height = 120, width = 120, units = "mm"
)

# save supplementary figure
ggsave(
  plot = plots_evo[[2]],
  filename = "supplement/figures/fig_evo_change_percent_cost.png",
  height = 120, width = 120, units = "mm"
)
```

## Compare movement, intake, and associations

```{r}
# list files, read, and filter for default model options
files = list.files(
  "data/results/gen_data", 
  pattern = "csv",
  full.names = TRUE
)

data_all = lapply(files, fread)
data_all = rbindlist(data_all)

data = data_all[(local == 1)]
data = data[!((cost == 0.1) & (infect_percent))]

# plot regen as rate per generation timesteps
data[, regen_r := gen_time / regen]
g_bin = 50
data[, gen_bin := floor(gen / g_bin) * g_bin]

# split by cost implementation
data = split(
  data,
  by = "infect_percent"
)
```

```{r}
plots_eco = lapply(
  data,
  function(df) {
    
    df = melt(
      df[, c("intake.mean", "moved.mean", "assoc.mean",
             "gen_bin", "cost", "regen_r", "repl")],
      id.vars = c("gen_bin", "cost", "regen_r", "repl")
    )
    
    df[, value := value / (max(value)), by = c("cost", "regen_r", "variable")]
    
    ggplot(df)+
      stat_summary(
        aes(
          gen_bin, value,
          group = interaction(variable, repl),
          col = variable
        ),
        geom = "point"
      )+
      geom_vline(
        xintercept = g_patho,
        lty = 2,
        size = 0.3,
        col = "red"
        # col = c("grey", "black", "grey")
      )+
      scale_colour_brewer(
        palette = "Accent",
        name = NULL
      )+
      scale_fill_brewer(
        palette = "Accent",
        name = NULL
      )+
      scale_x_continuous(
        # trans = ggallin::pseudolog10_trans,
        breaks = 500,
        labels = "Pathogen introduction",
        name = "Increasing productivity (social information less useful) \u279c",
        sec.axis = dup_axis(
          breaks = c(1, 500, 1000),
          labels = scales::comma_format(
            accuracy = 1
            # scale = 1/1000, suffix = "K"
          ),
          name = "Generations"
        )
      )+
      scale_y_continuous(
        labels = scales::percent,
        breaks = NULL,
        name = glue::glue("Increasing disease cost \u279c"),
        sec.axis = dup_axis(
          breaks = c(0, 0.5, 1),
          labels = scales::percent,
          name = "% of variable max."
        )
      )+
      facet_grid(
        cost ~ regen_r,
        as.table = F, 
        switch = c("both"),
        labeller = labeller(
          cost = function(x) sprintf("δE = %s", x),
          regen_r = function(x) sprintf("R = %s times/gen", x)
        )
      )+
      coord_cartesian(
        expand = T
      )+
      theme_test(
        base_size = 8, 
        base_family = "Arial"
      )+
      theme(
        legend.position = "top", 
        legend.key.height = unit(1, "mm"),
        strip.placement = "outside",
        strip.text = ggtext::element_markdown(),
        axis.text.x = element_text(hjust = 0.5, size = 6)
      )+
      guides(
        colour = guide_legend(
          override.aes = list(
            size = 2
          )
        )
      )
  }
)
```

```{r}
plots_eco = wrap_plots(
  plots_eco
)

plots_eco

ggsave(
  plot = plots_eco,
  filename = "figures/fig_compare_cost_type_eco.png",
  height = 100, width = 240, units = "mm"
)
```

