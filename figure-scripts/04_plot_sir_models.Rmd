---
editor_options: 
  chunk_output_type: console
---

# Plot networks and SIR models

```{r}
library(data.table)
devtools::load_all()

library(ggplot2)

library(patchwork)
library(colorspace)
```

## Plot default scenario

```{r}
# spillover data and rounding
popsize = 500
replicates = 10
data_sir_models = fread("data/results/data_sir_models.csv")

# data_sir_models$mean = data_sir_models$mean / 500
data_sir_models = data_sir_models[class == "NR" & gamma == 1 &
                                    beta == 5 & threshold %in% c(1, 10) ]

# select scenario
data_default = data_sir_models[regen == 50 & cost == 0.25]

# round time, with larger bins later in time
# ie, increments of 0, 0.25, 0.5, 1, 2, 5, 10 etc.
data_default[, tround := plyr::round_any(time, 0.25)]
data_default[, tround := fifelse(
  time > 5, plyr::round_any(time, 0.5),
  tround
)]
data_default[, type := factor(type, levels = c("pre", "post"))]

# save data default sir
fwrite(
  data_default,
  file = "data/results/data_default_sir.csv"
)
```

```{r}
# load saved data to save time
data_default = fread("data/results/data_default_sir.csv")
data_default[, type := factor(type, levels = c("pre", "post"))]
# data_default = split(data_default, by = "threshold")
```


```{r}
# plot the progress of disease in default network sir models
plot_default =
  ggplot(data_default)+
    geom_hline(
      yintercept = 0.5,
      col = "grey",
      size = 0.2
    )+
    geom_bin2d(
      aes(
        time, mean / popsize,
        fill = type,
        alpha = ..density..
      ),
      show.legend = F
    )+
    stat_summary(
      aes(
        tround, mean / popsize, 
        colour = type,
        shape = type,
        group = interaction(type, threshold, beta)
      ),
      stroke = 0.8,
      size = 0.3,
      position = position_dodge(width = 0.1),
      show.legend = F
    )+
    facet_wrap(
      ~threshold,
      labeller = labeller(
        threshold = c(
          "1" = "1 encounter",
          "10" = "10 encounters"
        )
      )
    )+
    scale_colour_discrete_diverging(
      l2 = 50,# l2 = 40,
      palette = "Blue-Red 2",
      rev = FALSE,
      # palette = "Plasma",
      breaks = c("pre", "post"),
      labels = c("Pre-pathogen intro.", "Post-pathogen intro.")
    )+
    scale_fill_discrete_diverging(
      palette = "Blue-Red 2",
      rev = FALSE,
      # palette = "Plasma",
      breaks = c("pre", "post"),
      labels = c("Pre-pathogen intro.", "Post-pathogen intro.")
    )+
    scale_shape_manual(
      values = c(
        "pre" = 16,
        "post" = 17
      ),
      breaks = c("pre", "post"),
      labels = c("Pre-pathogen intro.", "Post-pathogen intro.")
    )+
    scale_y_continuous(
      labels = scales::percent,
      # breaks = c(0.01, 0.33, 0.67, 1)
    )+
    scale_x_sqrt()+
    theme_test(
      base_size = 8
    )+
    theme(
      legend.position = "top",
      strip.background = element_blank(),
      strip.text = element_text(
        face = "bold"
      ),
      axis.text.y = element_text(
        angle = 90,
        hjust = 0.5,
        size = 6
      )
    )+
    coord_cartesian(
      xlim = c(0, 10),
      ylim = c(0, 1)
    )+
    labs(
      x = "SIR model time",
      y = "% Agents infected",
      fill = NULL,
      colour = NULL,
      shape = NULL
    )
```

Load previously saved network plots as a `ggplot` object from file.

```{r}
# loading network plots
load("figures/ggplot_network_figs.Rdata")
```

Wrap all figures and save as figure 3.

```{r}
# wrap figures
fig_3 = 
  wrap_plots(
  wrap_plots(
    networkplots,
    guides = "collect"
  ),
  wrap_plots(
    fig_degree
  ),
  plot_default,
  design = "AA\nAA\nBC"
) &
  plot_annotation(
    tag_levels = c("A")
  ) &
  theme(
    plot.tag = element_text(
      face = "bold"
    ),
    legend.position = "bottom"
  )
```


```{r}
ggsave(
  fig_3,
  filename = "figures/fig_03.png",
  height = 120,
  width = 120,
  units = "mm"
)
```
  )

ggsave(
  plot_sir_models,
  filename = "figures/fig_04_new.png",
  height = 60,
  width = 110,
  units = "mm"
)
```

