---
editor_options: 
  chunk_output_type: console
---

# Plot social outcomes in scenario 3

```{r}
library(data.table)
library(ggplot2)
library(patchwork)
library(colorspace)
```

```{r}
# load data
data = fread("data/results/data_si_morphs.csv")
data = data[gen > 4000]
```

## Summarise metrics by social strategy

```{r}
# summarise mean movement, mean associations, and proportion infected
# by social strategy
data_summary = data[, list(
  moved.mean = mean(moved),
  assoc.mean = mean(assoc),
  prop.infected = sum(t_infec > 0) / length(t_infec)
), by = c("gen", "repl", "social_strat", "cost", "regen")]

# melt data
data_summary = melt(
  data_summary,
  id.vars = c("gen", "repl", "social_strat")
)

# assign broad strategy
data_summary$social_strat = fifelse(
  data_summary$social_strat %in% c("agent avoiding", "handler tracking"),
  data_summary$social_strat, "other"
)

# split by variable
# data_summary = split(data_summary, by = "variable")
```

```{r}
data_summary = dcast(
  data_summary,
  formula = gen + repl + social_strat ~ variable,
  value.var = "value",
  fun.aggregate = mean
)
```

## Plot move and encounters

```{r}
plot_move_encounter =
  ggplot(data_summary)+
   geom_bin2d(
    aes(
      moved.mean, assoc.mean,
      fill = social_strat,
      group = social_strat,
      alpha = ..density..
    ),
    show.legend = T,
    position = position_identity(),
    binwidth = c(0.75, 0.05)
  )+
  scale_fill_discrete_sequential(
    palette = "Viridis",
    l1 = 10, l2 = 70,
    rev = F,
    name = NULL,
    labels = c(
      "Avoids \nall agents",
      "Tracks \nhandlers",
      "Other social\ninformation strategy"
    )
  )+
  geom_smooth(
    aes(
      moved.mean, assoc.mean,
      col = social_strat
    ),
    se = T,
    method = "glm",
    show.legend = F
  )+
  scale_colour_discrete_sequential(
    palette = "Viridis",
    l1 = 10, l2 = 70,
    rev = F,
    name = NULL,
    labels = c(
      "Avoids \nall agents",
      "Tracks \nhandlers",
      "Other social\ninformation strategy"
    )
  )+
  scale_alpha_continuous(
    range = c(0.2, 1)
  )+
  scale_y_continuous(
    trans = "log10",
    labels = scales::comma_format()
  )+
  coord_cartesian(
    xlim = c(60, 100),
    ylim = c(10, NA)
    # ratio = 40
  )+
  theme_test(
    base_family = "Arial"
  )+
  theme(
    axis.text.y = element_text(
      angle = 90,
      hjust = 0.5
    ),
    legend.key.height = unit(1, "mm"),
    legend.key.width = unit(1, "mm"),
    legend.position = "top",
    legend.justification = "right"
  )+
  labs(
    x = "Distance moved",
    y = "Encounters w/ individuals"
  )+
  guides(
    alpha = "none",
    shape = "none",
    colour = "none"
  )
```

```{r}
plot_infected =
  ggplot(data_summary)+
  ggdist::stat_histinterval(
    aes(
      social_strat, prop.infected,
      # colour = social_strat,
      fill = social_strat,
      group = social_strat,
      # alpha = ..pdf..
    ), 
    n = 31,
    show.legend = F
  )+
  scale_fill_discrete_sequential(
    palette = "Viridis",
    l1 = 10, l2 = 70,
    rev = F,
    name = NULL,
    labels = c(
      "Avoids \nall agents",
      "Tracks \nhandlers",
      "Other social\ninformation strategy"
    )
  )+
  scale_y_sqrt(
    labels = scales::percent,
    breaks = c(0.01, 0.25, 0.5, 1)
  )+
  scale_x_discrete(
    labels = c(
      "Avoids \nall agents",
      "Tracks \nhandlers",
      "Other\nstrategy"
    )
  )+
  theme_test()+
  theme(
    legend.position = "top",
    legend.key.height = unit(0.5, "mm"),
    legend.key.width = unit(2, "mm"),
    axis.text.y = element_text(
      angle = 90,
      hjust = 0.5
    ),
    axis.text.x = element_blank()
  )+
  labs(
    x = "Social information\nstrategy",
    y = "% Infected"
  )
```

```{r}
plot_soc_out =
wrap_plots(
  plot_move_encounter, plot_infected,
  guides = "collect",
  design = "AAB"
  ) &
  plot_annotation(
    tag_levels = "A"
  ) &
  theme(
    legend.position = "top",
    plot.tag = element_text(
      face = "bold"
    )
  )

ggsave(
  plot = plot_soc_out,
  file = "figures/fig_02.png",
  height = 87,
  width = 130,
  units = "mm"
)
```
