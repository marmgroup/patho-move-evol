---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Plot networks in final generations

```{r}
library(data.table)
library(tidygraph)
library(ggraph)
library(colorspace)
library(patchwork)
```

```{r}
load("data/results/data_networks.Rds")
```

```{r}
labels = c(
  "0" = "Sc. 1: No pathogen",
  "1" = "Sc. 2: Endemic pathogen",
  "2" = "Sc. 3: Spillover pathogen"
)
```

## Spillover scenario network plots

```{r}
# select nice network
ntwks_spillover = data_ntwk[[1]]

# select before and after disease
ntwk_pre = ntwks_spillover[[6]] %>% 
  activate(edges) %>% 
  filter(weight > 5) %>% 
  activate(nodes)

ntwk_post = ntwks_spillover[[7]] %>% 
  activate(edges) %>% 
  filter(weight > 5) %>% 
  activate(nodes)
```

```{r}
networkplots_spillover = lapply(
  list(ntwk_pre, ntwk_post), function(n) {
    ggraph(n, x = x, y = y)+
      geom_edge_fan(
        edge_width = 0.2,
        edge_alpha = 0.2,
        edge_color = "grey20"
      )+
      geom_node_point(
        aes(
          fill = t_infec, 
          size = assoc
        ),
        stroke = 0.3,
        shape = 21,
        # size = 3,
        # colour = "transparent",# "grey50",
        alpha = 0.9,
        show.legend = T
      )+
      scale_size(
        range = c(0.5, 2)
      )+
      scale_fill_continuous_sequential(
        palette = "Heat",
        limit = c(1, 100),
        # direction = -1,
        na.value = "lightblue"
        # trans = "sqrt"
      )+
      theme_graph(
        base_family = "Arial",
        background = "white",
        base_size = 10,
        plot_margin = margin(rep(0, 3))
      )+
      theme(
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.position = "top",
        legend.key.height = unit(1, units = "mm"),
        # panel.border = element_rect(
        #   colour = "grey",
        #   fill = "transparent"
        # )
      )+
      labs(
        fill = "Time infected"
      )+
      guides(
        size = "none"
      )
  })

networkplots_spillover = wrap_plots(
  networkplots_spillover, ncol = 2,
  guides = "collect"
) &
  plot_annotation(
    tag_levels = c("A")
  ) &
  theme(
    plot.tag = element_text(
      face = "bold"
    ),
    legend.position = "bottom"
  )
```

## Network metrics

```{r}
data_spillover = data_ntwk[names(data_ntwk) == "spillover"]

data_spillover = lapply(
  data_spillover, function(le) {
    list(
      pre = le[[6]],
      post = le[[7]]
    )
  }
)

data_pre = lapply(
  data_spillover, function(le) {
    le[["pre"]] |> 
      mutate(
        degree = tidygraph::centrality_degree(
          # weights = weight
        ),
        type = "pre"
      )
  }
)

data_post = lapply(
  data_spillover, function(le) {
    le[["post"]] |> 
      mutate(
        degree = tidygraph::centrality_degree(
          # weights = weight
        ),
        type = "post"
      )
  }
)
```

## Edge data

```{r}
data_pre_edge = lapply(
  data_pre, function(le) {
    get_edge_distance(le)
  }
) |> rbindlist()

data_post_edge = lapply(
  data_post, function(le) {
    get_edge_distance(le)
  }
) |> rbindlist()
```

```{r}
plot_dist_weight = lapply(
  list(data_pre_edge, data_post_edge), function(df) {
    ggplot()+
      geom_bin2d(
        data = df,
        aes(
          distance, weight,
          # fill = ..density..
        ),
        binwidth= c(1, 2),
        show.legend = F
      )+
      scale_fill_continuous_sequential(
        palette = "Batlow"
      )+
      # scale_y_sqrt()+
      coord_cartesian(
        xlim = c(0, 25),
        expand = F
      )+
      theme_minimal()+
      labs(
        x = "Distance",
        y = "Connection strength"
      )
  }
) |>
  wrap_plots()
```


```{r}
data_pre = lapply(data_pre, as_tibble) |> 
  rbindlist()
data_post = lapply(data_post, as_tibble) |> 
  rbindlist()

data = rbindlist(list(data_pre, data_post))
```

```{r}
ggplot(data)+
  geom_histogram(
    aes(
      degree,
      fill = type
    ),
    position = "identity"
  )+
  scale_x_sqrt()+
  scale_y_continuous(
    # labels = scales::percent
  )
```

```{r}
ggplot(data)+
  geom_jitter(
    aes(
      assoc, degree / 500,
      col = type,
      shape = type
    ),
    alpha = 0.5
  )+
  scale_colour_discrete_diverging(
    palette = "Blue-Yellow 3",
    rev = F,
    limits = c("pre", "post"),
    breaks = c("pre", "post"),
    labels = c(
      "Pre\nspillover", "Post\nspillover"
    )
  )+
  scale_shape(
    limits = c("pre", "post"),
    breaks = c("pre", "post"),
    labels = c(
      "Pre\nspillover", "Post\nspillover"
    )
  )+
  scale_y_log10()+
  scale_x_continuous(
    # trans = "log10",
    labels = scales::comma_format(),
    # breaks = c(0, seq(2500, 7500, 2500))
  )+
  coord_cartesian(
    # xlim = c(1, 7500)
  )+
  theme_test(
    base_family = "Arial"
  )+
  theme(
    axis.text.y = element_text(
      angle = 90,
      hjust = 0.5
    ),
    legend.key.height = unit(1, "mm"),
    legend.key.width = unit(1, "mm"),
    legend.position = "top",
    legend.justification = "right"
  )+
  labs(
    colour = NULL,
    shape = NULL,
    y = "Unique individuals",
    x = "Encounters"
  )
```

```{r}
ggplot(data)+
  ggdist::stat_histinterval(
    aes(
      type, degree / 500,
      fill = type
    ),
    # fill = "transparent",
    show.legend = F
  )+
  scale_alpha(
    # range = c(0, 0.5)
  )+
  scale_fill_discrete_diverging(
    palette = "Blue-Yellow 3",
    rev = T
  )+
  scale_x_discrete(
    limits = c("pre", "post"),
    breaks = c("pre", "post"),
    labels = c(
      "Pre\nspillover", "Post\nspillover"
    )
  )+
  scale_y_continuous(
    trans = ggallin::ssqrt_trans,
    labels = scales::percent
  )+
  labs(
    x = NULL,
    y = "% individuals encountered"
  )+
  theme_test(
    base_family = "Arial"
  )+
  theme(
    axis.text.y = element_text(
      angle = 90,
      hjust = 0.5
    ),
    legend.key.height = unit(1, "mm"),
    legend.key.width = unit(1, "mm"),
    legend.position = "top",
    legend.justification = "right"
  )+
  labs(
    x = NULL,
    y = "% Individuals encountered"
  )
```

```{r}
ggsave(
  plot = networkplots_spillover,
  filename = "figures/fig_03.png",
  height = 87,
  width = 114,
  units = "mm"
)
```

