---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Plot networks in final generations

```{r}
library(data.table)
library(tidygraph)
library(ggraph)
library(colorspace)
library(patchwork)
```

```{r}
load("data/results/data_networks.Rds")
```

```{r}
labels = c(
  "0" = "Sc. 1: No pathogen",
  "1" = "Sc. 2: Endemic pathogen",
  "2" = "Sc. 3: Spillover pathogen"
)
```

## Subset for reference combination

```{r}
key = lapply(data_ntwk, function(le) {
  tmp = first(le) |>
    as_tibble()
  
  cost = unique(tmp$cost)
  regen = unique(tmp$regen)
  
  list(cost = cost, regen = regen)
})

key = vapply(key, function(le) {
  le[["cost"]] == 0.25 & le [["regen"]] == 50
}, FUN.VALUE = c(T))
```

```{r}
data_ntwk = data_ntwk[key]
```

## Spillover scenario network plots

```{r}
# select nice network
ntwks_spillover = data_ntwk[[5]]

# select before and after disease
ntwk_pre = ntwks_spillover[[6]] %>% 
  activate(edges) %>% 
  filter(weight > 25) %>% 
  activate(nodes)

ntwk_post = ntwks_spillover[[7]] %>% 
  activate(edges) %>% 
  filter(weight > 5) %>% 
  activate(nodes)
```

```{r}
plot(
  ntwk_post, vertex.size = 3, vertex.label = NA
)
```

```{r}
networkplots_spillover = lapply(
  list(ntwk_pre, ntwk_post), function(n) {
    ggraph(n, x = xn, y = yn)+
    # ggplot(as_tibble(n))+
    #   geom_segment(
    #     aes(
    #       x = x, y = y,
    #       xend = xn, yend = yn
    #     ),
    #     size = 0.2,
    #     col = "indianred"
    #   )+
      geom_edge_fan(
        edge_width = 0.2,
        edge_alpha = 0.2,
        edge_color = "grey20"
      )+
      geom_node_point(
        aes(
          fill = t_infec,
          size = assoc
        ),
        stroke = 0.3,
        shape = 21,
        # size = 3,
        # colour = "transparent",# "grey50",
        alpha = 0.9,
        show.legend = T
      )+
      scale_size(
        range = c(0.5, 2)
      )+
      scale_fill_continuous_sequential(
        palette = "Inferno",
        limit = c(1, 100),
        breaks = c(1, 10, 30, 100),
        # direction = -1,
        na.value = "lightblue",
        trans = "sqrt"
      )+
      coord_equal(
        expand = T
      )+
      theme_graph(
        base_family = "Arial",
        background = "white",
        base_size = 8,
        plot_margin = margin(rep(0, 3))
      )+
      theme(
        axis.ticks = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        legend.margin = margin(rep(0, 4)),
        legend.position = "top",
        legend.title = element_text(size = 6),
        legend.key.height = unit(1, units = "mm"),
        legend.key.width = unit(3, units = "mm")
      )+
      labs(
        fill = "Time infected"
      )+
      guides(
        size = "none"
      )
  })

# wrap plots
networkplots_spillover = wrap_plots(
  networkplots_spillover, ncol = 2,
  guides = "collect"
) &
  plot_annotation(
    tag_levels = c("A")
  ) &
  theme(
    plot.tag = element_text(
      face = "bold"
    ),
    legend.position = "bottom"
  )
```

```{r}
ggsave(
  plot = networkplots_spillover,
  filename = "figures/fig_04_new.png",
  height = 69,
  width = 114,
  units = "mm"
)
```

