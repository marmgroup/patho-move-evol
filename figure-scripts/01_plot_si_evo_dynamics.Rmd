---
editor_options: 
  chunk_output_type: console
---

# Plot evolutionary consequences of spillover

```{r}
library(data.table)

library(ggplot2)
library(patchwork)
library(colorspace)

# custom functions
devtools::load_all()
```

Load data.

```{r}
# list files, read, and filter for default model options
files = list.files(
  "data/results/morph_data", 
  pattern = "csv",
  full.names = TRUE
)

data_all = lapply(files, fread)
data_all = rbindlist(data_all)

data = data_all[(local == 1) & (infect_percent == T)]
```

```{r}
# prepare to get proportions
popsize = 500

# get average strategy proportions over replicates
data[, prop := N / popsize]

g_bin = 10
data[, gen_bin := (floor(gen / g_bin) * g_bin)]

# prepare to scale productivity
gen_time = 100
# plot regen as rate per generation timesteps
data[, regen_r := gen_time / regen]
```

```{r}
fig_0 =
ggplot(data[
  social_strat != "non-handler tracking"
])+
  stat_summary(
    fun.max = ci_upper,
    fun.min = ci_lower,
    aes(
      gen_bin, prop, 
      fill = social_strat,
      alpha = gen_bin > 500
    ),
    col = "grey50",
    size = 0.05,
    geom = "ribbon"
  )+
  geom_vline(
    xintercept = 500,
    lty = 2,
    size = 0.3,
    col = "red"
    # col = c("grey", "black", "grey")
  )+
  scale_alpha_manual(
    values = c(
      "TRUE" = 0.8,
      "FALSE" = 1
    )
  )+
  scale_fill_discrete_sequential(
    palette = "Viridis", 
    rev = F,
    l1 = 30,
    c1 = 20,
    name = NULL,
    limits = c("agent avoiding", "agent tracking", "handler tracking"),
    labels = stringr::str_to_sentence,
    na.value = "lightgrey"
  )+
  scale_x_continuous(
    # trans = ggallin::pseudolog10_trans,
    breaks = 500,
    labels = "Pathogen introduction",
    name = "Increasing productivity (social information less useful) \u279c",
    sec.axis = dup_axis(
      # breaks = c(10, 250, 500) -,
      labels = scales::comma_format(
        accuracy = 1
        # scale = 1/1000, suffix = "K"
      ),
      name = "Generations"
    )
  )+
  scale_y_continuous(
    labels = scales::percent,
    breaks = NULL,
    name = glue::glue("Increasing disease cost \u279c"),
    sec.axis = dup_axis(
      breaks = c(0, 0.5, 1),
      labels = scales::percent,
      name = "% Individuals"
    )
  )+
  facet_grid(
    cost ~ regen_r, 
    as.table = F, 
    switch = c("both"),
    labeller = labeller(
      cost = function(x) sprintf("Î´E = %s", x),
      regen_r = function(x) sprintf("R = %s times/gen", x)
    )
  )+
  coord_cartesian(
    # expand = F,
    # ylim = c(0, 1),
    # xlim = c(1, 2000)
  )+
  theme_test(
    base_size = 8, 
    base_family = "Arial"
  )+
  theme(
    legend.position = "top", 
    legend.key.height = unit(1, "mm"),
    strip.placement = "outside",
    strip.text = ggtext::element_markdown(),
    axis.text.x = element_text(hjust = 0.5, size = 6)
  )+
  guides(
    alpha = "none",
    colour = guide_legend(
      override.aes = list(
        size = 2
      )
    )
  )

ggsave(
  plot = fig_0,
  filename = "figures/fig_00.png",
  height = 120, width = 120, units = "mm"
)
```
